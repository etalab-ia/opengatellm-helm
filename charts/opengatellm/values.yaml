fullnameOverride: ""
nameOverride: ""
namespaceOverride: ""
image:
  pullSecrets: []

opengatellm:
  serviceAccount:
    create: false
    name: ""
    annotations: {}
    labels: {}
  image:
    repository: ghcr.io/etalab-ia/opengatellm/api
    tag: "0.3.6"
    pullPolicy: IfNotPresent

  replicas: 1
  revisionHistoryLimit: ""

  gunicornArgs: ""

  logging:
    level: "INFO"

  resources:
    limits:
      cpu: "200m"
      memory: "1Gi"
    requests:
      cpu: "100m"
      memory: "512Mi"

  # Additional API container arguments
  extraArgs: {}

  # -- The name of the PriorityClass for API pods
  priorityClassName: ""

  dnsConfig: {}
  nodeSelector: {}
  affinity: {}

  # -- topologySpreadConstraints
  topologySpreadConstraints: {}

  annotations: {}
  persistence:
    subPath:

  # -- API probes configuration
  probes:
    readiness:
      httpGet:
        path: /health
        port: http
      initialDelaySeconds: 20
      periodSeconds: 15
    liveness:
      httpGet:
        path: /health
        port: http
      initialDelaySeconds: 120
      periodSeconds: 30

  # -- The SecurityContext for API deployment
  securityContext: {}

  # -- The SecurityContext for API containers
  containerSecurityContext: {}

  # -- GracePeriod of API container
  terminationGracePeriodSeconds: 10

  tolerations: []
  initContainers: []
  extraContainers: []
  extraVolumes: []
  extraVolumeMounts: []
  env: []
  extraEnvFrom: []

  service:
    type: ClusterIP
    port: 8000

  # -- Base config file for opengatellm. Contains Helm templates that are evaluated at install/upgrade.
  # To modify the resulting configuration, either copy and alter 'opengatellm.config' as a whole or use the 'opengatellm.structuredConfig' to add and modify certain YAML elements.
  config: |
    dependencies:
      postgres:
        url: ${POSTGRES_URI}
      redis:
        url: redis://:${REDIS_PASSWORD}@${REDIS_HOST}:${REDIS_PORT}

    settings:
      log_level: INFO

    models:
      {{ toYaml .Values.opengatellm.models | nindent 8 }}

  # -- Additional structured values on top of the text based 'opengatellm.config'. Applied after the text based config is evaluated for templates. Enables adding and modifying YAML elements in the evaluated 'opengatellm.config'.
  #
  # The base configuration (postgres, redis, settings) is defined in 'config' above.
  # Use structuredConfig to override or add additional configuration when using this chart as a dependency.
  #
  # Example for parent chart adding Elasticsearch:
  #
  # opengatellm:
  #   structuredConfig:
  #     dependencies:
  #       elasticsearch:
  #         hosts: http://my-elasticsearch:9200
  #     settings:
  #       vector_store_model: "BAAI/bge-m3"
  #
  structuredConfig: {}

  #
  # -- Models list to append to opengatellm.config
  #
  # Example:
  #
  #models:
  # - name: albert
  #   type: text-generation
  #   providers:
  #     - type: vllm
  #       model_name: "gemma3:1b"
  #       url: ${ALBERT_URL}
  #       key: ${ALBERT_KEY}
  models:
    - name: albert-testbed
      type: text-generation
      providers:
        - type: vllm
          model_name: "gemma3:1b"
          url: "http://albert-testbed.etalab.gouv.fr:8000"
          key: "changeme"

  #
  # -- Secret loaded into env variable
  #
  # Example:
  #
  # existingModelSecret: "my-model-secrets"
  #
  # You need to create secret before install/upgrade
  #
  # apiVersion: v1
  # kind: Secret
  # metadata:
  #   name: my-models-secrets
  # type: Opaque
  # stringData:
  #   ALBERT_URL: https://example.com/api
  #   ALBERT_KEY: changeme
  #
  existingModelSecret: "albert-model-secret"

  #
  # -- Secret loaded into env variable
  #
  # Example:
  #
  # existingModelSecret: "my-settings-secrets"
  #
  # You need to create secret before install/upgrade
  #
  # apiVersion: v1
  # kind: Secret
  # metadata:
  #   name: my-settings-secrets
  # type: Opaque
  # stringData:
  #   MASTER_USERNAME: admin
  #   MASTER_KEY: admin
  #
  existingSettingSecret: ""

ingress:
  # -- Specifies whether an ingress for the api should be created
  enabled: false
  # -- Ingress Class Name.
  ingressClassName: ""
  # -- Annotations for the gateway ingress
  annotations: {}
  # -- Labels for the gateway ingress
  labels: {}
  # -- Hosts configuration for the api ingress, passed through the `tpl` function to allow templating
  hosts:
    - host: api.example.com
      paths:
        - path: /
          # -- pathType (e.g. ImplementationSpecific, Prefix, .. etc.) might also be required by some Ingress Controllers
          # pathType: Prefix
  # -- TLS configuration for the gateway ingress. Hosts passed through the `tpl` function to allow templating
  tls:
    - secretName: api-example-com-tls
      hosts:
        - api.example.com

postgresql:
  # -- Install or not cnpg cluster
  # Ensure CNPG Operator is installed on your cluster
  enabled: true
  # Values from cnpg/cluster charts https://github.com/cloudnative-pg/charts/tree/main/charts/cluster
  fullnameOverride: "cluster-opengatellm"
  version:
    # -- PostgreSQL major version to use
    postgresql: "17"
  mode: standalone
  # -- The original cluster name when used in backups. Also known as serverName.
  clusterName: "cluster-opengatellm"
  # -- Name of the database used by the application. Default: `api`.
  database: api
  pgBaseBackup:
    database: api
    source:
      database: "api"
  cluster:
    # -- Number of instances
    instances: 1
    storage:
      size: 1Gi
      storageClass: ""
    walStorage:
      size: 1Gi
      storageClass: ""
    resources:
      limits:
        cpu: 250m
        memory: 512Mi
      requests:
        cpu: 250m
        memory: 512Mi
    affinity:
      topologyKey: topology.kubernetes.io/zone
    logLevel: info
    primaryUpdateMethod: switchover
    primaryUpdateStrategy: unsupervised
    enableSuperuserAccess: true
    monitoring:
      # -- Whether to enable monitoring
      enabled: false
      podMonitor:
        # -- Whether to enable the PodMonitor
        enabled: false
    # -- BootstrapInitDB is the configuration of the bootstrap process when initdb is used.
    initdb:
      database: api
      encoding: UTF8

  # -- Configuration secret for an external PostgreSQL
  #
  # existingPostgresSecret: "postgres-secret"
  #
  # You need to create secret before install/upgrade
  #
  # apiVersion: v1
  # kind: Secret
  # metadata:
  #   name: postgres-secret
  # type: Opaque
  # stringData:
  #   POSTGRES_USER: api
  #   POSTGRES_PASSWORD: changeme
  #   POSTGRES_HOST: localhost
  #   POSTGRES_PORT:5432
  #   POSTGRES_URI: postgresql+asyncpg://api:changeme@localhost:5432/api
  #
  existingPostgresSecret: ""

redis:
  # -- Install or not redis-ha cluster
  enabled: true
  # Values from redis-ha chart https://github.com/DandyDeveloper/charts/tree/master/charts/redis-ha
  # -- Redis name
  name: redis
  # -- Number of redis replicas (1 for standalone, 3+ for HA)
  replicas: 1
  ## Redis image - Using Redis Stack to support JSON, Search, TimeSeries, and Bloom modules
  image:
    # -- Redis repository
    repository: "redis/redis-stack-server"
    # -- Redis tag
    tag: "7.4.0-v8"
  ## Prometheus redis-exporter sidecar
  exporter:
    # -- Enable Prometheus redis-exporter sidecar
    enabled: false
    # -- Repository to use for the redis-exporter
    #image: ""
    # -- Tag to use for the redis-exporter
    #tag: ""
  persistentVolume:
    # -- Configures persistence on Redis nodes
    enabled: true
    size: 10Gi
  ## Redis specific configuration options
  redis:
    # -- Redis convention for naming the cluster group: must match `^[\\w-\\.]+$` and can be templated
    masterGroupName: opengatellm
    # -- Any valid redis config options in this section will be applied to each server (see `redis-ha` chart)
    # @default -- See [values.yaml]
    config:
      # Load Redis Stack modules from correct path
      loadmodule:
        - /opt/redis-stack/lib/redistimeseries.so
        - /opt/redis-stack/lib/rejson.so
        - /opt/redis-stack/lib/redisearch.so
        - /opt/redis-stack/lib/redisbloom.so
      # Enable AOF https://redis.io/topics/persistence#append-only-file
      appendonly: "yes"
      # -- Will save the DB if both the given number of seconds and the given number of write operations against the DB occurred. `""`  is disabled
      # Disable RDB persistence, AOF persistence already enabled.
      # @default -- `'""'`
      save: '""'
      # Standalone mode: don't wait for replicas to acknowledge writes
      min-replicas-to-write: 0

  # -- Configures redis-ha with AUTH
  auth: true
  redisPassword: "changeme"
  ## Use existing secret containing key `authKey` (ignores redisPassword)
  ## Can also store AWS S3 or SSH secrets in this secret
  ## Supports templates like "{{ .Release.Name }}-creds"
  # -- An existing secret containing a key defined by `authKey` that configures `requirepass` and `masterauth` in the conf
  # parameters (Requires `auth: enabled`, cannot be used in conjunction with `.Values.redisPassword`)
  existingSecret: ""
  # -- Defines the key holding the redis password in existing secret.
  authKey: REDIS_PASSWORD

  sentinel:
    auth: false
    password: ""
    # -- An existing secret containing a key defined by `sentinel.authKey` that configures `requirepass`
    # in the conf parameters (Requires `sentinel.auth: enabled`, cannot be used in conjunction with `.Values.sentinel.password`)
    # Supports templates like "{{ .Release.Name }}-sentinel-creds"
    existingSecret: ""
    ## Defines the key holding the sentinel password in existing secret.
    # -- The key holding the sentinel password in an existing secret.
    authKey: REDIS_PASSWORD

  # -- Whether the Redis server pods should be forced to run on separate nodes (disable for single-node clusters).
  hardAntiAffinity: false

  # -- Redis HA statefulset container-level security context
  # @default -- See [values.yaml]
  containerSecurityContext:
    readOnlyRootFilesystem: true

  # -- Configuration secret for an external Redis
  #
  # existingRedisSecret: "redis-secret"
  #
  # You need to create secret before install/upgrade
  #
  # apiVersion: v1
  # kind: Secret
  # metadata:
  #   name: redis-secret
  # type: Opaque
  # stringData:
  #   REDIS_HOST: redis.opengatellm.svc.cluster.local
  #   REDIS_PORT: 6379
  #   REDIS_PASSWORD: changeme
  #   REDISÃ¨USER: api
  #
  existingRedisSecret: ""